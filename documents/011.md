# 问题描述

某个环境（容器为websphere）每隔一个月左右会出现调用一个接口超时的问题，需要重启才能恢复正常。
查看调用开始和调用结束的日志，发现时间相差大概30秒，但是接口内部实现只是查询数据库里的单张表，直接连接数据库执行该sql只需要零点几秒。
开始以为可能是数据库的问题，于是在接口中使用缓存并且加了2条日志。但是一个月后仍然出现相同的问题，查看日志后发现缓存有效没有查询数据库，说明不是数据库的问题。调用开始和调用结束的日志的相差时间变成了1分30秒左右，这2条日志加上后面新加的2条日志一共4条日志，这4条日志之间的相邻的2条日志的间隔都是30秒。

# 原因排查

由于log4j2.xml中配置了mongodb，并且该环境没有可用的mongodb，导致连接不上mongodb，日志中经常有连接mongodb被拒绝，等待超过30秒的异常。连接不到mongodb等待30秒后报错，调用接口的两个日志之间也是相差30秒，这个问题很有可能就是mongodb导致的，但是log4j2.xml中配置的是异步日志，打印日志花费30秒应该不会影响接口执行。

通过[https://blog.csdn.net/u010597819/article/details/89605607](https://blog.csdn.net/u010597819/article/details/89605607)了解到log4j2的2.7版本的异步日志在RingBuffer满了（最大值在org.apache.logging.log4j.core.async.DisruptorUtil第79行获取，如果是在web容器中启动，最大值为4 \* 1024，不是则为256 \* 1024）之后会默认使用当前线程进行打印日志。

经过本地测试，故意设置一个连接不到的mongodb地址，在debug启动时将DisruptorUtil中的RingBufferSize调小，并且在一个简单接口中增加几条日志，多次调用该接口让RingBuffer的值达到RingBufferSize，然后再调用该接口，发现接口返回的时候刚好和日志数量乘以30秒差不多（测试时接口打印5条日志，后面调用接口返回的时间刚好是2分30秒），和上述结论一致。
